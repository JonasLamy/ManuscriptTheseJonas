\chapter{Perspectives et bilan}

% Ce que nous avons fait
% Notre ressenti
% Y a t'il une place pour d'autres filtres de rehaussement ?
% Le rehaussement a t'il un futur ?

\section{Bilan du rehaussement}

\subsection{Rehaussement et deep learning}

Nous n'avons pas encore abordé la question de la place du rehaussement parmi les méthodes de segmentation populaires actuellement. En effet, le deep learning a pris une place très importante dans la littérature d'aujourd'hui, en particulier les réseaux end-to-end qui intègrent l'ensemble des traitements menant à la segmentation. Ces réseaux apprennent leur propre modèle interne et extraient leurs propres caractéristiques pour définir leur propre critère de segmentation. On peut donc se demander quelle est la nécessité d'incorporer des filtres de rehaussement aux réseaux de neurones.

Comme nous l'avons présenté dans le chapitre 3, les filtres de rehaussement de vaisseaux viennent en amont de la segmentation. On peut donc également les utiliser en amont d'un réseau de neurone. Les performances du deep learning sont largement influencées par le type de données qui lui sont présentées. On cherche notamment à ce qu'une base de donnée soit la plus représentative du problème que l'on cherche à traiter. Plusieurs méthodes d'intégrations des filtres de rehaussement sont possibles. La première méthode est de filtrer une base de donnée initiale et de présenter au réseau les données filtrées. On peut ainsi espérer guider l'apprentissage du réseau en mettant en valeur les structures tubulaires et en éliminant les autres structures.

\subsection{Futur du rehaussement}
%deep 
Ces dernières années, le deep learning est la technologie la plus explorée pour résoudre des tâches complexes de segmentation. En particulier,  on privilégie les méthodes de bout en bout. Ces méthodes concentrent toute la chaine traitement dans un réseau de neurone. Celui-ci apprend de lui-même à élaborer un modèle, à extraire des caractéristiques et à segmenter un organe. Comme on a pu le voir précédemment, le rehaussement s'applique en amont des chaines de traitement de la segmentation et il peut donc aussi s'appliquer en amont des réseaux de neurones. Le traitement des jeux de données en deep learning est particulièrement important, puisque dans ces systèmes, c'est le jeu de données qui va contrôler la capacité du réseau à se spécialiser sur un problème ou au contraire à le généraliser. Un jeu de données se doit donc d'être le plus représentatif du problème que l'on cherche à traiter.

Les filtres de rehaussement de vaisseaux peuvent faciliter cette représentativité, puisqu'ils permettent de mettre en valeur les vaisseaux tout en éliminant une partie des autres structures. On peut de plus utiliser différents filtres ou différentes paramétrisations pour augmenter artificiellement nos données ou renforcer l'apprentissage de vaisseaux spécifiques.
% deep + vesselness

\todo{Comment citer un papier pas encore publié ?}
Affane et al. \ref{Article Abir} ont fait l'expérience de tester plusieurs combinaisons de filtres de rehaussement (Jerman, Sato, RORPO et Zhang) et d'architectures de réseaux de neurones (Unet, Dense Net, MultiRes Unet). les expériences sont menées sur la base de l'Ircad avec les filtres optimisés dont les paramètres optimaux ont été trouvé par notre banc de test. Les résultats des expériences montrent que le rehaussement, en particulier le rehaussement homogène de Jerman peut aider les réseaux à mieux segmenter les vaisseaux. En particulier, l'usage des filtres montre son efficacité lorsque les réseaux sont entrainé sur des données plus réduites. Affane et al. illustrent ce cas en entrainant les réseaux avec des blocs (couches d'un volume de quelques voxels d'épaisseurs) plutôt qu'avec des volumes entiers. Survarachakan \cite{Survarachakan2021_deep_vesselness} a proposé des travaux similaires qui valident, eux aussi, l'utilisation des filtres de rehaussement d'améliorer la segmentation de réseaux de type Unet.
% unification de modalité
Les réseaux de neurones sont aussi connu pour avoir du mal à généraliser d'une modalité à une autre. En effet, l'apparence des vaisseaux peut changer selon les modalités ainsi que le contexte alentour. Les sorties des filtres de rehaussement ont aussi l'avantage d'être défini dans un domaine relativement homogène. On peut donc imaginer se servir des filtres de rehaussement pour unifier les modalités. On pourrait ainsi créer des jeux de données mixtes contenant des filtres issues de modalités différentes et ainsi améliorer la généralisation des réseaux.
% information multispectrale
Une autre manière d'utiliser les filtres de rehaussement avec le deep learning est de considérer le résultat d'un filtrage comme une composante spectrale. Ainsi, au lieu de remplacer les volumes présentés aux réseaux par des volumes filtrés, on concatène aux données initiales plusieurs filtrages. Un vaisseau est ainsi décrit par son aspect initial ainsi que par plusieurs types de rehaussements qui fournissent des données complémentaires. Lors de l'apprentissage, un réseau de neurone peut alors choisir la combinaison d'informations qui lui permet de segmenter au mieux les vaisseaux.

\subsection{Amélioration du rehaussement}

Une autre question est la place de nouveaux filtres de rehaussement dans la littérature. Notre avis sur la question est que les filtres existants offrent une solution à une bonne partie des problèmes rencontrés par le rehaussement. Toutefois, les avantages des filtres sont éparpillés à travers un certain nombre d'entre eux : Par exemple, la gestion du bruit proposé par le filtre de Frangi est particulièrement efficace tout comme la manière d'homogénéiser le rehaussement proposé par Jerman. Ces deux propriétés mériteraient d'être fusionnées dans un seul filtre. On aurait ainsi un filtre similaire à celui de Jerman qui serait plus résistant au bruit. Nous n'avons pas étudié le cadre de OOF de manière extensive, mais celui-ci mériterait d'être testé avec des mesures de tubularité plus élaborées (Frangi, Sato, Jerman, etc.) afin d'évaluer plus précisément l'étalement du rehaussement.

Enfin, il est peut-être envisageable de proposer un filtre de rehaussement basé sur un apprentissage à base de deep learning, cependant il est difficile de voir l'apport qu'aurait une telle méthode par rapport à des réseaux qui effectuent directement de la segmentation.

Nous l'avons répété plusieurs fois au cours de ce manuscrit, produire des annotations est une tâche critique pour le développement de nouveaux algorithmes de segmentation des vaisseaux. Cependant, on ne peut pas demander à des médecins de bloquer des heures consacrées à l'annotation de volumes alors quelles pourraient être consacrées à s'occuper de malades. Le manque de personnel dans les hôpitaux ne semble pas indiquer une amélioration de cette situation. La gestion toujours plus strictes des données médicales, n'aide pas non plus à faciliter de telles collectes et annotations données. Ces observations prennent à contre-pied la tendance du deep learning à exploiter toujours plus de données.

Nous avons tenté une approche qui cherche à réduire au minimum le temps passé à annoter un volume. En effet, la communauté est plus à même d'obtenir des bases de données annotées si le temps d'annotation passe de 30 à 60 min à une dizaine de minutes. Dans un réseau vasculaire, il n'existe vraiment qu'un seul type de points remarquables : les bifurcations. Celles-ci correspondent par définition au commencement d'au moins deux vaisseaux en aval et à la terminaison d'un vaisseau en amont et peuvent donc servir de point de départ pour des algorithmes de suivis de vaisseaux. De plus, si l'on considère que le médecin ne doit positionner qu'un seul point au centre de chaque bifurcation, le temps d'annotations est drastiquement réduit. En comparaison, une segmentation des vaisseaux nécessite d'annoter l'ensemble des pixels des vaisseaux.
 
Une segmentation des vaisseaux à partir des bifurcations revient donc à :

\begin{itemize}
\item Localiser les bifurcations.
\item Construire une hiérarchie entre les bifurcations.
\item Extraire le réseau vasculaire (ligne centrale ou segmentation).
\end{itemize}

Une fois les bifurcations identifiées, il est possible de les relier deux à deux par un parcours de chemin de type Djiksra en fournissant une carte de coût qui peut être le résultat d'un filtre de rehaussement de vaisseaux. En prenant un filtre dont le rehaussement est dégressif sur les bords (Frangi, Sato, Jerman $\tau > 0.5$) on peut favoriser les chemins passant par le centre des vaisseaux. Si l'on veut aller plus loin, on peut même en partie reconstruire les vaisseaux en estimant le rayon des vaisseaux à partir de leur ligne centrale.

Le challenge ici est donc la détection et la localisation des bifurcations. En termes de modélisation, les bifurcations sont difficiles à définir. On considère d'habitude les bifurcations comme des zones en forme de blob, c'est-à-dire où le gradient s'éloigne du centre dans toutes les directions. Cette théorie est plus fragile lorsqu'elle est confrontée à la réalité des cas pratiques. Par exemple, si les vaisseaux composant la bifurcation ne font pas la même taille, les gradients se trouvent déportés sur les bords et la géométrie se trouve plus aplatie que circulaire. Par conséquent, la variabilité des bifurcations les rend difficile à modéliser par un filtre de rehaussement. Jerman et al. a proposé un filtre de rehaussement pour les anévrismes (blobs) \cite{Jerman2015_blobness}, mais il a dû compléter la méthode par un système de visualisation particulier, car les blobs étant rehaussés de manière non homogène. Ce filtre appliqué aux bifurcations ne donne pas de résultats très pertinents.

Nous avons aussi testé une combinaison de filtres. Nous avons en effet constaté que le filtre de Sato, lorsque que $\alpha_1$ était bas, provoquant des trous bien visibles dans la réponse des bifurcations. Nous avons essayé de différencier le manque de signal des bifurcations du manque de signal dans les régions homogènes (vides) en faisant une différence entre le filtre de Sato et le filtre de Jerman (Fig. \ref{fig:subtract_vesselness}). Deux problèmes apparaissent. Un reste de signal est présent aux bifurcations, mais la délimitation de celui-ci est très variable, formant parfois des structures plates plutôt que sphériques, confirmant nos observations précédentes. De plus le filtre de Jerman estime le rayon des vaisseaux de manière plus large que le filtre de Sato. En faisant la différence $Jerman-Sato$ on se retrouve avec un résultat qui ressemble à l'intérieur d'un bambou avec une seule composante connexe qui entoure les vaisseaux (chambres d'air) et séparées en compartiment par des jonctions mal délimitées correspondant aux bifurcations.

\begin{figure}[ht]
    \centering
    \includegraphics[height=4cm]{Images/SatoFilter_bif.png}
    \includegraphics[height=4cm]{Images/JermanFilter_bif.png}
    \includegraphics[height=4cm]{Images/subJermanSato_bif.png}
    \caption{Filtre de Sato (Blanc), Filtre de Jerman (Rouge), différence $Jerman - Sato$ (plasma). Bien que le signal du rehaussement soit plus fort sur les bifurcations, la visualisation en coupe montre une exploitation difficile de cette méthode.}
    \label{fig:subtract_vesselness}
\end{figure}

Face à la variabilité des bifurcations, nous nous sommes tourné vers le deep learning afin de développer une méthode résistante aux variations de géométrie.

L'ensemble de nos expériences ont été réalisée avec des jeux de données synthétiques VascuSynth dont on connait la position des bifurcations.

Nous avons d'abords tenté de segmenter les bifurcations en utilisant comme vérité terrain les masques des bifurcations que nous avons construits pour le banc de test. Pour cela, nous avons entrainé un réseau classique, Unet, auquel nous avons présenté des volumes entiers. Pour la segmentation du réseau vasculaire entier, cette configuration fonctionne bien et les performances du réseau entrainé fonctionnent bien. Cependant, pour les masques des bifurcations, le réseau n'arrive pas à faire converger les segmentations vers ceux-ci. En observant les étapes d'entrainement, nous avons observé que le réseau convergeait dans un premier temps vers la segmentation des vaisseaux avant d'essayer de converger vers les bifurcations. Ce comportement nous a paru curieux. Deux hypothèses sont probables, les masques des segmentations des bifurcations ne sont pas assez représentatifs des bifurcations ou la segmentation des bifurcations est un sous problème de la segmentation des vaisseaux, plus difficile (Fig. \ref{fig:seg_deep}).

\begin{figure}[ht]
    \centering
    \includegraphics[height=4cm]{Images/exp_seg_gt.png}
    \includegraphics[height=4cm]{Images/exp_seg_40.png}
    \includegraphics[height=4cm]{Images/exp_seg_100.png}
    \includegraphics[height=4cm]{Images/exp_seg_200.png}
    \caption{Tentative de segmentation des bifurcations. Inférence à l'itération 40, 100 et 200. Volume en gris, vérité terrain des bifurcations en vert et sortie du réseau en rouge. }
    \label{fig:seg_deep}
\end{figure}

Nous avons ensuite changé d'approche en passant à la classification de patchs contenants une bifurcation ou non. Pour cette classification, nous avons dans un premier temps utilisé des patchs contenant une seule bifurcation dont la position était alignée avec le pixel central des patchs. Nous avons utilisé un réseau de neurone inspiré de l'architecture VGG, c'est-à-dire un réseau avec un encodeur formé de couches convolutionnelles suivi de couches de neurones entièrement connectées. La sortie du réseau est formé d'un seul neurone donnant la probabilité d'appartenance d'un patch à une bifurcation. 

Afin de ne contenir qu'une seule bifurcation par patchs, nous avons choisis une taille de 16x16x16 (Fig. \ref{fig:exp_patchs}). Cette taille impose l'utilisation de réseaux avec peu de couches convolutionnelles car la sortie de ces couches est accompagnée d'une opération de max pooling, qui réduit la taille spatiale du volume d'entrée. 

\begin{figure}[ht]
    \centering
    \includegraphics[height=4cm]{Images/exp_patchs_exemple.png}
    \caption{3 exemples de patchs. Le patch central est un patch positif, les deux autres des patchs négatifs.}
    \label{fig:exp_patchs}
\end{figure}

Les patchs positifs sont tirés aléatoirement dans le volume entier, dans un rayon supérieur à une dizaine de pixels des bifurcations. Nous n'avons pas réussi à faire converger ce premier essai. Nous avons cherché la cause en faisant varier les couches du réseau, ses paramètres (taux d'entrainement, utilisation du pooling ou non) sans succès. Nous avons ensuite augmenté la taille des patchs de 16x16x16 à 32x32x32 ce qui a permis au réseau de converger pour la première fois.

Les résultats de classifications de patchs étaient relativement correctes, cependant, la classification appliquée à une image complète possédait des résultats très faibles. Nous avons en effet remarqué que le réseau avait tendance à classifier comme bifurcations l'ensemble de l'intérieur des vaisseaux à proximité de la ligne centrale. Une de nos hypothèses a alors été de penser que l'ensemble des bifurcations était un sous ensemble de la ligne centrale. Un réseau apprenant à identifier les lignes centrales aurait une précision très haute de détection des bifurcations, puisque lors de l'entrainement, les patchs négatifs de lignes centrales sont très peu représentés. 

La difficulté a été de construire une méthode pour tirer des patchs proches de la ligne centrale des vaisseaux sans vérité terrain des vaisseaux. En effet, utiliser des informations supplémentaires aurait été à l'encontre des contraintes initiales que nous nous sommes posées. Nous avons donc choisis d'utiliser des filtres de rehaussement pour tirer des patchs dont le pixel central avait une forte probabilité d'appartenir à des vaisseaux. Cette méthode n'a pas cependant pas réglé le problème des réseaux qui continue à ce jour de classifier l'ensemble de la ligne centrale comme une bifurcation.

\begin{figure}[ht]
    \centering
    \includegraphics[height=8cm]{Images/exp_bifurcations.png}
    \caption{Exemples de résultats de classifications sur patchs tirés dans un volume. Les points représentent le centre de patchs de taille 32x32x32 (le volume total fait 128x128x128 pixels). VN=jaune, VP=Vert, FP=Bleu, FN=marron}
    \label{fig:exp_patchs}
\end{figure}

Il est possible que le modèle VGG ne soit pas adapté à la tâche, car le pooling détruit l'information des vaisseaux. Dans un réseau de segmentation type Unet, les structures fines sont conservées par des skip connections qui ne peuvent pas être mises en place dans ce type dans ce type d'architecture.

\section{ Bilan des travaux}

Nous avons articulé l'ensemble de nos travaux de manière à ce qu'ils constituent un socle de connaissances et d'outils pour une personne souhaitant approfondir ses connaissances sur les filtres de rehaussement de vaisseaux. 

Nous avons dans un premier temps établi un état de l'art des filtres de rehaussement recouvrant les 20 dernières années. Nous avons ensuite identifié 7 filtres se démarquant de la littérature par la solution proposée pour répondre à des problèmes différents et complémentaires levés par le rehaussement de vaisseaux. Nous avons aussi explicité les différents cadres d'échelles qui permettent au rehaussement d'être efficace sur l'ensemble du réseau vasculaire malgré des variations de tailles importantes des vaisseaux.

Nous avons ensuite décidé d'améliorer l'accessibilité des filtres de rehaussement en proposant de rassembler, adapter et réimplémenter les 7 filtres dans un cadre commun en C++. La personne souhaitant utiliser des filtres de rehaussement, peut ainsi éviter de passer par cette étape très chronophage de recherche et d'adaptation de filtres provenant de sources multiples. 

Puis, nous avons ensuite proposé un banc de test, permettant de comparer les performances de ces filtres de manière quantitative dans différents contextes. Assez tôt dans sa conception, nous avons fait en sorte que celui-ci soit modulable et extensible par d'autres utilisateurs. Il permet ainsi d'ajouter un nouveau filtre à la base de travail existante qui devient ainsi évolutive, plutôt que de repartir de zéro.

Les expériences que nous avons menées avec ce banc de test ont mis en valeur les différences significatives entre les filtres de rehaussement. Les filtres Hessiens ou de flux proposant des rehaussements lisses, mais parfois surestimés ou rehaussant des bordures d'organes. En opposition, RORPO est plus précis dans les structures rehaussées, mais leur aspect est beaucoup plus irrégulier. Les filtres se distinguent aussi par leur résistance au bruit avec des filtres plutôt performants pour de faibles niveaux de bruits, comme Jerman et Sato, mais dont les performances chutent lorsque le bruit augmente. À l'inverse le filtre de Frangi propose un mécanisme intéressant pour le contrôle du bruit.

Nous avons aussi fait en sorte que l'implémentation des filtres et du banc de test soient à la fois complémentaires et indépendants. De cette manière chaque partie peut être réutilisée chacune de son côté. Nous avons d'ailleurs tiré parti de cette propriété en proposant une démonstration en ligne des filtres qui permet de tester, sans installation, les filtres de rehaussement sur des données de l'utilisateur. L'intégration des filtres de rehaussement a aussi été intégré dans un logiciel de visualisation d'images médicales : 3DSlicer. Les filtres peuvent ainsi être directement utilisés de manière interactive dans celui-ci.

Enfin, pour compenser le manque d'annotations, nous avons participé à l'élaboration d'un Plug-In de segmentation, afin que les bases de données hépatiques avec annotations des vaisseaux se démocratisent. Nous avons aussi exploré une méthode de segmentation à partir des seules annotations des bifurcations.

Nous avons donc élaboré un travail couvrant tous les aspects nécessaires l'étude du rehaussement : Le développement des bases de données, la théorie du rehaussement, la mise en pratique des filtres ainsi que leur évaluation.